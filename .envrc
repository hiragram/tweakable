# Get the common git directory parent (shared across all worktrees
MAIN_REPO=$(git rev-parse --path-format=absolute --git-common-dir 2>/dev/null | sed 's|/.git$||' || git rev-parse --show-toplevel)
SECRETS_FILE="$MAIN_REPO/.secrets"

if [[ -f "$SECRETS_FILE" ]]; then
    source "$SECRETS_FILE"
else
    # Fetch from 1Password and cache
    export GEMINI_API_KEY=$(op read "op://Dev/gemini-api-key/credential")
    export SUPABASE_DATABASE_PASSWORD=$(op read "op://okumuka/supabase/db-password")
    export SUPABASE_PUBLISHABLE_API_KEY=$(op read "op://okumuka/supabase/publishable-api-key")
    export SUPABASE_PROJECT_URL=$(op read "op://okumuka/supabase/project-url")

    # Create cache file
    cat > "$SECRETS_FILE" << EOF
export GEMINI_API_KEY="$GEMINI_API_KEY"
export SUPABASE_DATABASE_PASSWORD="$SUPABASE_DATABASE_PASSWORD"
export SUPABASE_PUBLISHABLE_API_KEY="$SUPABASE_PUBLISHABLE_API_KEY"
export SUPABASE_PROJECT_URL="$SUPABASE_PROJECT_URL"
EOF
    chmod 600 "$SECRETS_FILE"
fi

# Generate ios-secrets.json from environment variables
./scripts/generate-ios-secrets-json

# Get the common git directory parent (shared across all worktrees
MAIN_REPO=$(git rev-parse --path-format=absolute --git-common-dir 2>/dev/null | sed 's|/.git$||' || git rev-parse --show-toplevel)
SECRETS_FILE="$MAIN_REPO/.secrets"

if [[ -f "$SECRETS_FILE" ]]; then
    source "$SECRETS_FILE"
else
    # Fetch from 1Password and cache
    export GEMINI_API_KEY=$(op read "op://Dev/gemini-api-key/credential")

    # Create cache file
    cat > "$SECRETS_FILE" << EOF
export GEMINI_API_KEY="$GEMINI_API_KEY"
EOF
    chmod 600 "$SECRETS_FILE"
fi

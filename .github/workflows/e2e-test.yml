name: E2E Tests

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (skip issue creation)'
        required: false
        default: 'false'
        type: boolean

permissions:
  issues: write

jobs:
  e2e-test:
    runs-on: self-hosted

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create CI simulator
        run: |
          CI_SIM_NAME="CI-E2E-iPhone-17-Pro-${GITHUB_RUN_ID}"
          echo "CI_SIM_NAME=$CI_SIM_NAME" >> "$GITHUB_ENV"
          xcrun simctl delete "$CI_SIM_NAME" 2>/dev/null || true
          CI_DEVICE_ID=$(xcrun simctl create "$CI_SIM_NAME" \
            com.apple.CoreSimulator.SimDeviceType.iPhone-17-Pro \
            com.apple.CoreSimulator.SimRuntime.iOS-26-2)
          xcrun simctl boot "$CI_DEVICE_ID"
          sleep 5
          xcrun simctl spawn "$CI_DEVICE_ID" defaults write .GlobalPreferences AppleLanguages -array ja en
          xcrun simctl spawn "$CI_DEVICE_ID" defaults write .GlobalPreferences AppleLocale -string ja_JP
          xcrun simctl shutdown "$CI_DEVICE_ID"
          sleep 2
          xcrun simctl boot "$CI_DEVICE_ID"
          echo "CI_DEVICE_ID=$CI_DEVICE_ID" >> "$GITHUB_ENV"

      - name: Run E2E Tests
        uses: sersoft-gmbh/xcodebuild-action@v4
        with:
          project: Tweakable.xcodeproj
          scheme: TweakableUITests
          destination: 'platform=iOS Simulator,id=${{ env.CI_DEVICE_ID }}'
          action: test
          result-bundle-path: E2ETestResults.xcresult
          build-settings: CODE_SIGNING_ALLOWED=NO
          retry-tests-on-failure: true
          test-iterations: 3
          parallel-testing-enabled: false

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: E2ETestResults
          path: E2ETestResults.xcresult

      - name: Delete CI simulator
        if: always()
        run: |
          xcrun simctl delete "$CI_SIM_NAME" 2>/dev/null || true

  create-fix-issue:
    needs: e2e-test
    if: failure() && github.event_name == 'push'
    uses: ./.github/workflows/create-test-failure-issue.yml
    with:
      test-type: E2E
      label: e2e-test-failure
      scheme: TweakableUITests
      commit-sha: ${{ github.sha }}
      run-id: ${{ github.run_id }}

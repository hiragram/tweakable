#!/usr/bin/perl
use strict;
use warnings;
use JSON::PP;

my $script_dir = $0 =~ s|/[^/]+$||r;
my $root_dir = "$script_dir/..";
my $keys_path = "$root_dir/ios-secrets-keys.json";
my $output_path = "$root_dir/ios-secrets.json";

# Read keys list
open my $fh, '<', $keys_path or die "Cannot open $keys_path: $!";
my $json_text = do { local $/; <$fh> };
close $fh;

my $keys = decode_json($json_text);

# Build secrets hash from environment variables
my %secrets;
for my $key (@$keys) {
    my $value = $ENV{$key} // '';
    $secrets{$key} = $value;
}

# .supabase-local-port ファイルがあれば読み込む（worktreeごとの動的ポート対応）
my $port_file = "$root_dir/.supabase-local-port";
if (-f $port_file) {
    if (open my $pf, '<', $port_file) {
        my $port = <$pf>;
        close $pf;
        chomp $port if $port;
        $secrets{"SUPABASE_LOCAL_PORT"} = $port if $port && $port =~ /^\d+$/;
    }
} else {
    # ファイルがない場合はデフォルト値（CI環境やリリースビルドで使用）
    $secrets{"SUPABASE_LOCAL_PORT"} = "54321";
}

# Write JSON
open my $out, '>', $output_path or die "Cannot write $output_path: $!";
print $out JSON::PP->new->pretty->canonical->encode(\%secrets);
close $out;

print "Generated $output_path\n";

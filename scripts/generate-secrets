#!/usr/bin/perl
use strict;
use warnings;
use JSON::PP;

my $srcroot = $ENV{SRCROOT};
unless ($srcroot) {
    die "error: SRCROOT environment variable is not set.\nhint: This script must be run from Xcode build phase.\n";
}

my $json_path = "$srcroot/ios-secrets.json";
my $output_file = "$srcroot/AppCore/Secrets.generated.swift";

# Check if JSON file exists
unless (-f $json_path) {
    die "error: $json_path not found.\nhint: Run 'direnv allow' in the project directory to generate ios-secrets.json\n";
}

# Read and parse JSON
open my $fh, '<', $json_path or die "Cannot open $json_path: $!";
my $json_text = do { local $/; <$fh> };
close $fh;

my $secrets = decode_json($json_text);

# Generate Swift code
my @private_vars;
my @public_vars;

for my $key (sort keys %$secrets) {
    my $value = $secrets->{$key};
    my $swift_name = lc($key);
    $swift_name =~ s/_([a-z])/\u$1/g;  # Convert SNAKE_CASE to camelCase

    push @private_vars, "    private static let _$swift_name = \"$value\"";
    push @public_vars, <<"EOF";
    public static var $swift_name: String {
        guard !_$swift_name.isEmpty else {
            fatalError("Secrets.$swift_name is not configured. Check ios-secrets.json")
        }
        return _$swift_name
    }
EOF
}

# Write Swift file
open my $out, '>', $output_file or die "Cannot write $output_file: $!";
print $out <<"EOF";
// Auto-generated by generate-secrets - DO NOT EDIT
import Foundation

public enum Secrets {
@{[join("\n", @private_vars)]}

@{[join("\n", @public_vars)]}
}
EOF
close $out;

print "Generated $output_file\n";

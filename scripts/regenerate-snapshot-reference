#!/bin/bash
#
# regenerate-snapshot-reference
#
# スナップショットテストのリファレンス画像を再生成するスクリプト
#
# 処理内容:
# 1. スナップショットリファレンス画像のディレクトリを削除
# 2. スナップショットテストを実行（リファレンス画像がないため失敗する）
# 3. スナップショットテストを再実行（再生成された画像で成功するはず）
#

set -e

cd "$(git rev-parse --show-toplevel)"

SNAPSHOTS_DIR="AppCoreTests/__Snapshots__/PreviewTests"
SCHEME="AppCore"
DESTINATION="platform=iOS Simulator,name=iPhone 17 Pro"
TEST_TARGET="AppCoreTests/PreviewTests"

echo "=== スナップショットリファレンス画像の再生成 ==="
echo ""

# Step 1: リファレンス画像を削除
echo "Step 1: リファレンス画像を削除しています..."
if [ -d "$SNAPSHOTS_DIR" ]; then
    rm -rf "$SNAPSHOTS_DIR"
    echo "  削除完了: $SNAPSHOTS_DIR"
else
    echo "  スナップショットディレクトリが見つかりません: $SNAPSHOTS_DIR"
    exit 1
fi
echo ""

# Step 2: スナップショットテストを実行（リファレンス画像再生成のため、失敗が期待される）
echo "Step 2: スナップショットテストを実行（リファレンス画像を再生成）..."
echo "  ※ リファレンス画像がないため、このテスト実行は失敗します"
echo ""

# テストを実行（失敗が期待されるため || true で継続）
xcodebuild test \
    -scheme "$SCHEME" \
    -destination "$DESTINATION" \
    -only-testing:"$TEST_TARGET" \
    2>&1 || true

echo ""
echo "Step 2 完了: リファレンス画像が再生成されました"
echo ""

# Step 3: スナップショットテストを再実行（成功が期待される）
echo "Step 3: スナップショットテストを再実行（検証）..."
echo ""

xcodebuild test \
    -scheme "$SCHEME" \
    -destination "$DESTINATION" \
    -only-testing:"$TEST_TARGET" \
    2>&1

echo ""
echo "=== 完了: スナップショットリファレンス画像の再生成に成功しました ==="

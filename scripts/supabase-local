#!/bin/bash
set -e

# ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨Supabaseèµ·å‹•ãƒ»åœæ­¢ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
# worktreeã”ã¨ã«ç‹¬ç«‹ã—ãŸã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã™ã‚‹
# ä½¿ã„æ–¹: ./scripts/supabase-local [start|stop|status|studio|ports|stop-all]

SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
SUPABASE_DIR="$PROJECT_ROOT/supabase"

# worktreeå¯¾å¿œ: --workdirã‚ªãƒ—ã‚·ãƒ§ãƒ³ã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
WORKDIR_OPT="--workdir $PROJECT_ROOT"

# è‰²ä»˜ãå‡ºåŠ›
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_info() {
    echo -e "${BLUE}â„¹ï¸  $1${NC}"
}

print_success() {
    echo -e "${GREEN}âœ“ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âœ— $1${NC}"
}

show_help() {
    cat << EOF
Usage: $0 [command]

Commands:
    start     Supabaseãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•
    stop      Supabaseãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢
    status    Supabaseã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    studio    Supabase Studioã‚’ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ã
    ports     ç¾åœ¨ã®worktreeã®ãƒãƒ¼ãƒˆè¨­å®šã‚’è¡¨ç¤º
    stop-all  å…¨worktreeã®Supabaseã‚³ãƒ³ãƒ†ãƒŠã‚’ä¸€æ‹¬åœæ­¢ãƒ»å‰Šé™¤
    logs      Supabaseã®ãƒ­ã‚°ã‚’è¡¨ç¤º
    reset     ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†é©ç”¨ï¼‰
    help      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º

Examples:
    $0 start    # Supabaseã‚’èµ·å‹•
    $0 stop     # Supabaseã‚’åœæ­¢
    $0 ports    # ãƒãƒ¼ãƒˆè¨­å®šã‚’ç¢ºèª
    $0 studio   # Supabase Studioã‚’é–‹ã
    $0 stop-all # å…¨worktreeã®ã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢

Note:
    worktreeåã‹ã‚‰ãƒãƒƒã‚·ãƒ¥è¨ˆç®—ã§ãƒãƒ¼ãƒˆãŒæ±ºå®šã•ã‚Œã¾ã™ã€‚
    åŒã˜worktreeåã§ã‚ã‚Œã°ã€å†èµ·å‹•å¾Œã‚‚åŒã˜ãƒãƒ¼ãƒˆãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚
EOF
}

# worktreeåã‹ã‚‰ãƒãƒ¼ãƒˆã‚’è¨ˆç®—
calculate_ports() {
    WORKTREE_NAME=$(basename "$PROJECT_ROOT")

    # macOSã¨Linuxã§md5ã‚³ãƒãƒ³ãƒ‰ãŒç•°ãªã‚‹
    if command -v md5 &> /dev/null; then
        # macOS
        HASH=$(echo -n "$WORKTREE_NAME" | md5 | cut -c1-4)
    else
        # Linux
        HASH=$(echo -n "$WORKTREE_NAME" | md5sum | cut -c1-4)
    fi

    # 16é€²æ•°ã‚’10é€²æ•°ã«å¤‰æ›ã—ã¦ãƒãƒ¼ãƒˆç¯„å›²ã‚’è¨ˆç®—
    BASE_PORT=$((0x$HASH % 10000 + 50000))

    # å„ã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ªãƒ•ã‚»ãƒƒãƒˆã‚’åŠ ç®—
    SUPABASE_API_PORT=$((BASE_PORT + 1))
    DB_PORT=$((BASE_PORT + 2))
    SHADOW_PORT=$((BASE_PORT + 3))
    STUDIO_PORT=$((BASE_PORT + 4))
    INBUCKET_PORT=$((BASE_PORT + 5))
    ANALYTICS_PORT=$((BASE_PORT + 6))
    EDGE_RUNTIME_PORT=$((BASE_PORT + 7))

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDï¼ˆCIç”¨ã¨åŒºåˆ¥ã™ã‚‹ãŸã‚ã« okumuka-worktree- prefixï¼‰
    SUPABASE_PROJECT_ID="okumuka-worktree-${WORKTREE_NAME}"
}

# config.tomlã‚’å‹•çš„ã«ç”Ÿæˆ
generate_config() {
    local CONFIG_DEFAULT="$SUPABASE_DIR/config.toml.default"
    local CONFIG_FILE="$SUPABASE_DIR/config.toml"

    if [ ! -f "$CONFIG_DEFAULT" ]; then
        print_error "config.toml.default ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: $CONFIG_DEFAULT"
        exit 1
    fi

    # æ—¢å­˜ã®config.tomlãŒã‚ã‚Œã°å‰Šé™¤
    if [ -f "$CONFIG_FILE" ]; then
        rm -f "$CONFIG_FILE"
    fi

    print_info "config.toml ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™..."
    cp "$CONFIG_DEFAULT" "$CONFIG_FILE"

    # OSã‚’åˆ¤å®šã—ã¦sedã‚³ãƒãƒ³ãƒ‰ã‚’èª¿æ•´
    if [[ "$OSTYPE" == "darwin"* ]]; then
        # macOS
        SED_INPLACE() {
            sed -i '' "$@"
        }
    else
        # Linux
        SED_INPLACE() {
            sed -i "$@"
        }
    fi

    # config.tomlã‚’æ›´æ–°
    cd "$SUPABASE_DIR"
    SED_INPLACE "s/^port = [0-9]*/port = $SUPABASE_API_PORT/" config.toml
    SED_INPLACE "/^\[db\]/,/^\[/ s/^port = [0-9]*/port = $DB_PORT/" config.toml
    SED_INPLACE "s/^shadow_port = [0-9]*/shadow_port = $SHADOW_PORT/" config.toml
    SED_INPLACE "/^\[studio\]/,/^\[/ s/^port = [0-9]*/port = $STUDIO_PORT/" config.toml
    SED_INPLACE "/^\[inbucket\]/,/^\[/ s/^port = [0-9]*/port = $INBUCKET_PORT/" config.toml
    SED_INPLACE "/^\[analytics\]/,/^\[/ s/^port = [0-9]*/port = $ANALYTICS_PORT/" config.toml
    SED_INPLACE "s/^inspector_port = [0-9]*/inspector_port = $EDGE_RUNTIME_PORT/" config.toml
    SED_INPLACE "s/^project_id = .*/project_id = \"$SUPABASE_PROJECT_ID\"/" config.toml

    cd "$PROJECT_ROOT"
}

# ãƒãƒ¼ãƒˆæƒ…å ±ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜ï¼ˆã‚¢ãƒ—ãƒªå´ã§å‚ç…§ã™ã‚‹ãŸã‚ï¼‰
save_port_file() {
    echo "$SUPABASE_API_PORT" > "$PROJECT_ROOT/.supabase-local-port"
    print_info "ãƒãƒ¼ãƒˆæƒ…å ±ã‚’ .supabase-local-port ã«ä¿å­˜ã—ã¾ã—ãŸ"
}

# ios-secrets.json ã‚’å†ç”Ÿæˆ
regenerate_secrets() {
    if [ -x "$PROJECT_ROOT/scripts/generate-ios-secrets-json" ]; then
        print_info "ios-secrets.json ã‚’å†ç”Ÿæˆã—ã¦ã„ã¾ã™..."
        "$PROJECT_ROOT/scripts/generate-ios-secrets-json"
    else
        print_warning "generate-ios-secrets-json ãŒè¦‹ã¤ã‹ã‚‰ãªã„ã‹å®Ÿè¡Œã§ãã¾ã›ã‚“"
    fi
}

check_docker() {
    if ! docker info > /dev/null 2>&1; then
        print_error "DockerãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚Docker Desktopã‚’èµ·å‹•ã—ã¦ãã ã•ã„ã€‚"
        exit 1
    fi
}

cmd_ports() {
    calculate_ports

    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“‹ worktree: $WORKTREE_NAME"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "  Project ID:     $SUPABASE_PROJECT_ID"
    echo "  Base Port:      $BASE_PORT"
    echo "  API Port:       $SUPABASE_API_PORT"
    echo "  DB Port:        $DB_PORT"
    echo "  Shadow Port:    $SHADOW_PORT"
    echo "  Studio Port:    $STUDIO_PORT"
    echo "  Inbucket Port:  $INBUCKET_PORT"
    echo "  Analytics Port: $ANALYTICS_PORT"
    echo "  Edge Runtime:   $EDGE_RUNTIME_PORT"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "ğŸ”— URLs:"
    echo "  Supabase API:   http://localhost:$SUPABASE_API_PORT"
    echo "  Supabase Studio: http://localhost:$STUDIO_PORT"
    echo "  Inbucket:       http://localhost:$INBUCKET_PORT"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

cmd_start() {
    check_docker
    calculate_ports
    generate_config

    print_info "Supabaseãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’èµ·å‹•ã—ã¦ã„ã¾ã™..."
    print_info "worktree: $WORKTREE_NAME"
    print_info "Project ID: $SUPABASE_PROJECT_ID"

    if npx supabase start $WORKDIR_OPT; then
        # ãƒãƒ¼ãƒˆæƒ…å ±ã‚’ä¿å­˜
        save_port_file

        # ios-secrets.json ã‚’å†ç”Ÿæˆ
        regenerate_secrets

        print_success "SupabaseãŒèµ·å‹•ã—ã¾ã—ãŸï¼"
        echo ""
        cmd_ports
    else
        print_error "Supabaseã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
        exit 1
    fi
}

cmd_stop() {
    calculate_ports
    print_info "Supabaseãƒ­ãƒ¼ã‚«ãƒ«ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’åœæ­¢ã—ã¦ã„ã¾ã™..."
    print_info "Project ID: $SUPABASE_PROJECT_ID"

    if npx supabase stop $WORKDIR_OPT; then
        print_success "Supabaseã‚’åœæ­¢ã—ã¾ã—ãŸã€‚"
    else
        print_warning "Supabaseã¯æ—¢ã«åœæ­¢ã—ã¦ã„ã‚‹ã‹ã€åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
    fi
}

cmd_status() {
    calculate_ports
    if npx supabase status $WORKDIR_OPT 2>/dev/null; then
        print_success "Supabaseã¯èµ·å‹•ä¸­ã§ã™ã€‚"
    else
        print_warning "Supabaseã¯åœæ­¢ã—ã¦ã„ã¾ã™ã€‚'./scripts/supabase-local start' ã§èµ·å‹•ã—ã¦ãã ã•ã„ã€‚"
    fi
}

cmd_studio() {
    calculate_ports

    # ã¾ãšã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’ç¢ºèª
    if ! npx supabase status $WORKDIR_OPT > /dev/null 2>&1; then
        print_warning "SupabaseãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚èµ·å‹•ã—ã¾ã™ã‹ï¼Ÿ (y/N)"
        read -r response
        if [[ "$response" =~ ^[Yy]$ ]]; then
            cmd_start
        else
            exit 0
        fi
    fi

    STUDIO_URL="http://localhost:$STUDIO_PORT"
    print_info "Supabase Studioã‚’é–‹ã„ã¦ã„ã¾ã™: $STUDIO_URL"

    if [[ "$OSTYPE" == "darwin"* ]]; then
        open "$STUDIO_URL"
    elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
        xdg-open "$STUDIO_URL" 2>/dev/null || print_warning "ãƒ–ãƒ©ã‚¦ã‚¶ã§ $STUDIO_URL ã‚’é–‹ã„ã¦ãã ã•ã„"
    else
        print_info "ãƒ–ãƒ©ã‚¦ã‚¶ã§ $STUDIO_URL ã‚’é–‹ã„ã¦ãã ã•ã„"
    fi
}

cmd_logs() {
    calculate_ports
    print_info "Supabaseã®ãƒ­ã‚°ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™... (Ctrl+Cã§çµ‚äº†)"
    docker compose -p "supabase_$SUPABASE_PROJECT_ID" logs -f
}

cmd_reset() {
    calculate_ports
    print_warning "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚"
    echo "ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ (y/N)"
    read -r response

    if [[ "$response" =~ ^[Yy]$ ]]; then
        print_info "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ã„ã¾ã™..."
        if npx supabase db reset $WORKDIR_OPT; then
            print_success "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸã€‚"
        else
            print_error "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒªã‚»ãƒƒãƒˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚"
            exit 1
        fi
    else
        print_info "ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚"
    fi
}

cmd_stop_all() {
    print_info "å…¨worktreeã®Supabaseã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¦ã„ã¾ã™..."

    # okumuka-worktree- ã§å§‹ã¾ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã®ã‚³ãƒ³ãƒ†ãƒŠã®ã¿ã‚’å¯¾è±¡
    # CIç”¨ã® okumuka-e2e ãªã©ã¯å«ã¾ã‚Œãªã„
    containers=$(docker ps -a --filter "name=supabase_okumuka-worktree-" --format "{{.Names}}" 2>/dev/null | sort -u)

    if [ -z "$containers" ]; then
        print_info "åœæ­¢ã™ã‚‹worktreeç”¨ã‚³ãƒ³ãƒ†ãƒŠãŒã‚ã‚Šã¾ã›ã‚“ã€‚"
        return 0
    fi

    # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆIDã‚’æŠ½å‡ºã—ã¦ä¸€æ„ã«ã™ã‚‹
    project_ids=$(echo "$containers" | sed 's/^supabase_//' | sed 's/_.*$//' | sort -u)

    for project_id in $project_ids; do
        print_info "åœæ­¢ä¸­: $project_id"
        # --volumes ã§ãƒœãƒªãƒ¥ãƒ¼ãƒ ã‚‚å‰Šé™¤ã€--rmi ã¯æŒ‡å®šã—ãªã„ã®ã§ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯æ®‹ã‚‹
        docker compose -p "supabase_$project_id" down --volumes --remove-orphans 2>/dev/null || true
    done

    print_success "å…¨ã¦ã®worktreeç”¨Supabaseã‚³ãƒ³ãƒ†ãƒŠã‚’åœæ­¢ã—ã¾ã—ãŸã€‚"
    print_info "â€» Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã¯æ®‹ã£ã¦ã„ã¾ã™ã€‚å®Œå…¨å‰Šé™¤ã¯ 'docker image prune' ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
}

# ãƒ¡ã‚¤ãƒ³å‡¦ç†
case "${1:-help}" in
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    studio)
        cmd_studio
        ;;
    ports)
        cmd_ports
        ;;
    stop-all)
        cmd_stop_all
        ;;
    logs)
        cmd_logs
        ;;
    reset)
        cmd_reset
        ;;
    help|--help|-h)
        show_help
        ;;
    *)
        print_error "ä¸æ˜ãªã‚³ãƒãƒ³ãƒ‰: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
